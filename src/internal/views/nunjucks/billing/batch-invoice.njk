{% extends "./nunjucks/layout.njk" %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "./nunjucks/billing/macros/totals.njk" import invoiceTotal,
invoiceCreditsTotal,
invoiceDebitsTotal %}
{% from "./nunjucks/billing/macros/transactions-table.njk" import transactionsTable, twoPartTariffTransactionsTable %}

{% from "badge.njk" import badge %}
{% from "crm/invoice-address.njk" import invoiceAddress %}
{% from "./nunjucks/billing/macros/batch-metadata.njk" import batchMetadata %}
{% from "./nunjucks/billing/macros/batch-buttons.njk" import removeInvoiceFromBatchButton %}

{% block content %}
  <div class="govuk-grid-row govuk-!-margin-bottom-0">
    <div class="govuk-grid-column-two-thirds">
      <div class="govuk-!-margin-bottom-6">
        {{ title(pageTitle, caption, false, true, true) }}
      </div>

      <div class="govuk-body govuk-!-margin-bottom-4">
        {{ badge(batch | batchBadge(true)) }}
      </div>

      {{ batchMetadata(batch)}}

      <div class="govuk-!-margin-bottom-9">
        {% set html %}
        {{ invoiceAddress(invoice) }}
        {% endset %}
        {{ govukDetails({
          summaryText: "Billing contact address",
          html: html })
        }}
      </div>
    </div>
  </div>

  <!-- Net total -->
  <div class="govuk-grid-row govuk-!-margin-bottom-3">
    <div class="govuk-grid-column-two-thirds">
      <h2 class="govuk-!-margin-bottom-0">
        {{ invoiceTotal(invoice.totals.netTotal, invoice.totals.netTotal < 0) }}
      </h2>
    </div>
  </div>
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-one-half">
      <h2>
        {{ invoiceCreditsTotal(invoice.totals.creditLineValue) }}
      </h2>
    </div>
    <div class="govuk-grid-column-one-half">
      <h2>
        {{ invoiceDebitsTotal(invoice.totals.debitLineValue) }}
      </h2>
    </div>
  </div>

  <div class="govuk-grid-row govuk-!-margin-bottom-0">
    <div class="govuk-grid-column-two-thirds">
      {{ removeInvoiceFromBatchButton(batch, invoice) }}
    </div>
  </div>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <hr class="govuk-section-break section-break--heavy section-break--margin-7"/>

      {% for financialYear, licences in transactions %}
        <h2 class="govuk-heading-xl">{{ financialYear }}</h2>

        {% for licenceNumber, licence in licences %}
          <h3 class="govuk-heading-l govuk-!-margin-bottom-0">Licence
            {{ licenceNumber }}</h3>
          <p>
            <a href="{{ licence.link }}">View licence</a>
          </p>

          {% for group in licence.chargeElements %}

            {% set insetHtml %}
            <h4 class="govuk-heading-m govuk-!-margin-bottom-1">
              {{ group.chargeElement.purposeUse.name }},
              {{ group.chargeElement.description }}
            </h4>

            <p class="govuk-body">
              {{ group.chargeElement.abstractionPeriod | abstractionPeriod }}
            </p>
            {% endset %}

            {{ govukInsetText({
              html : insetHtml
            }) }}

            {% if batch.type == 'two_part_tariff' %}
              {{ twoPartTariffTransactionsTable(group) }}
            {% else %}
              {{ transactionsTable(group) }}
            {% endif %}

          {% endfor %}

        {% endfor %}

      {% endfor %}

    </div>
  </div>

{% endblock %}