{% extends "./nunjucks/layout.njk" %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "badge.njk" import badge %}

<!--set title-->
{% set title = [data.stations[data.stationID].riverName] + " at " + [data.stations[data.stationID].label] %}

{% block pageTitle %}
  {{title}} - GOV.UK
{% endblock %}

{% block content %}
  <!-- page title -->
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-l govuk-!-margin-bottom-1">
        <span class="govuk-caption-l">{{[data.stations[data.stationID].catchmentName]}}</span>
        {{title}}
      </h1>
      {% set metaData %}
        {{ govukSummaryList({
        classes: 'govuk-summary-list--no-border',
        rows: [
          {
            key: {
              text: "Grid reference",
              classes: "meta-data__label"
            },
            value: {
              text: [data.stations[data.stationID].gridReference],
              classes: "meta-data__value"
            }
          } if data.stations[data.stationID].gridReference,
          {
            key: {
              text: "Easting",
              classes: "meta-data__label"
            },
            value: {
              text: [data.stations[data.stationID].easting],
              classes: "meta-data__value"
            }
          } if data.stations[data.stationID].easting,
          {
            key: {
              text: "Northing",
              classes: "meta-data__label"
            },
            value: {
              text: [data.stations[data.stationID].northing],
              classes: "meta-data__value"
            }
          } if data.stations[data.stationID].northing,
          {
            key: {
              text: "WISKI ID",
              classes: "meta-data__label"
            },
            value: {
              text: [data.stations[data.stationID].wiskiId],
              classes: "meta-data__value"
            }
          } if data.stations[data.stationID].wiskiId,
          {
            key: {
              text: "Station reference",
              classes: "meta-data__label"
            },
            value: {
              text: [data.stations[data.stationID].stationReference],
              classes: "meta-data__value"
            }
          } if data.stations[data.stationID].stationReference
        ]
        }) }}
      {% endset %}

    {{ govukDetails({
      summaryText: "Station details",
      html: metaData
    }) }}

  </div>
</div>


{% set tags = data.stations[data.stationID]['tags'] %}
{% if tags.length %}
  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-full">
      {{ govukButton({
    text: "Create a water abstraction alert",
    href: "licence-notices/send-a-water-abstraction-alert/select-the-type-of-alert?stationID=" + [data.stationID]
  }) }}
    </div>
  </div>
{% endif %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <!-- Start tag-table.html: Licences linked to this monitoring station -->
    {% block service %}
        <!--setting the loop number to 0-->
        {% set loopNumber = "" %}

        <!--getting the licence data-->
        {% set tags = data.stations[data.stationID]['tags'] %}
        {% if tags.length %}
          <table class="govuk-table">
            <caption class="govuk-table__caption govuk-table__caption--m">Licences linked to this monitoring station</caption>
            <thead class="govuk-table__head">
              <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header ">Licence</th>
                <th scope="col" class="govuk-table__header ">Abstraction period</th>
                <th scope="col" colspan="3" class="govuk-table__header ">Flow and level restriction<br> type and threshold </th>
                <th scope="col" colspan="2" class="govuk-table__header ">Last type of alertâ€¨ <br>sent and date issued</th>
              </tr>
            </thead>
            <tbody class="govuk-table__body">
            <!--starting to loop through the bill runs data -->

            {% for i in tags %}
              <!--setting the loop number -->
              {% set loopNumber = loop.index0 %}
              <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                  <!--set the link to go to a specific licence-->
                  {% for licence in data['licences']%}
                    {% if licence.number == i.licenceNumber %}
                      <a href="licence?ID={{loop.index0}}" class="govuk-link">
                    {% endif %}
                  {% endfor %}
                  {{i.licenceNumber}}</a>
                </td>

                <!--get the tags for that individual licences-->
                {% set licenceTags = i['tagValues'] %}

                <td class="govuk-table__cell ">
                  {% set period = licenceTags[0].abstractionPeriod %}
                  {{ period.periodStart | abstractionPeriod }} to {{ period.periodEnd | abstractionPeriod }} <br>
                </td>
                <td class="govuk-table__cell ">
                  <!--loop through conditions for that licence-->
                  {% for tag in licenceTags %}
                    {{tag.conditionType |capitalize}}<br>
                    {{tag.comstatus}}<br>          
                  {% endfor %}
                </td>
                <td class="govuk-table__cell govuk-table__cell--numeric">
                  <!--loop through the tag values and if they are a flow value add them to this cell-->
                  {% for tag in licenceTags %}
                    {{tag.thresholdValue}}<br>
                  {% endfor %}
                </td>
                <td class="govuk-table__cell ">
                  <!--loop through the tag values and if they are a flow value add them to this cell  | units |safe -->
                  {% for tag in licenceTags %}
                    {{tag.thresholdUnits}}<br>
                  {% endfor %}
                </td>
                {% for licence in data['licences']%}
                  {% if licence.number == i.licenceNumber %}
                    {% if data.licences[loop.index0]['communications'].length %}
                      {% set communications = data.licences[loop.index0]['communications'] %}
                      <!-- type.split(" ")[0] | capitalize -->
                      <td class="govuk-table__cell ">
                        {% set commsType = '' + communications[0].type.trim().replace(' ','_') %}
                        {{ badge({status:[commsType]} | gaugingStationBadge(false) ) }}
                      </td>
                      <td class="govuk-table__cell">  {{communications[0].sent}}</td>
                    {% else %}
                      {% set communications = "" %}
                      <td class="govuk-table__cell"> </td>
                      <td class="govuk-table__cell"> </td>
                    {% endif %}

                  {% endif %}
                {% endfor %}
              </tr>
              {% endfor %}

            </tbody>
          </table>

          <div class="govuk-button-group">
            {{ govukButton({
              text: "Tag a licence",
              href: "monitoring-stations/" + [data.stationID] + "/new-tag",
              classes: "govuk-button--secondary"
            }) }}

            {{ govukButton({
              text: "Remove a tag",
              href: "monitoring-stations/" + [data.stationID] + "/remove-tag",
              classes: "govuk-button--secondary"
            }) }}
          </div>

        {% else %}
          <p class="govuk-body">There are no licences tagged with restrictions for this monitoring station</p>
          {{ govukButton({
            text: "Tag a licence",
            href: "monitoring-stations/" + [data.stationID] + "/new-tag",
            classes: "govuk-button--secondary"
          }) }}

        {% endif %}

      <!-- end tag table block-->
      {% endblock %}
    </div>
  </div>

<!--End content block-->
{% endblock %}
